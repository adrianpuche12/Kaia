// Prisma Schema para Kaia - Sistema Completo
// Base de datos: SQLite (desarrollo) / PostgreSQL (producción)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
//  USUARIOS Y CONFIGURACIÓN
// ========================================

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String // Hasheado con bcrypt
  phone     String?   @unique
  name      String
  lastName  String?
  birthDate DateTime?

  // Perfil adicional
  address String?
  city    String?
  country String?
  avatar  String? // URL del avatar

  // Onboarding
  onboardingCompleted Boolean @default(false)

  // Relaciones
  preferences   UserPreferences?
  events        Event[]
  reminders     Reminder[]
  alarms        Alarm[]
  voiceSessions VoiceSession[]
  messages      Message[]
  contacts      Contact[]
  locationLogs  LocationLog[]
  places        Place[]
  mcpExecutions MCPExecution[]

  // Relaciones con sistema de IA
  contexts        Context[]
  clusters        Cluster[]
  actions         Action[]
  interactionLogs InteractionLog[]
  patterns        Pattern[]
  feedbacks       UserFeedback[]

  // Push Notifications
  pushTokens PushToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model UserPreferences {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Preferencias de Voz
  voiceEnabled Boolean @default(true)
  voiceGender  String  @default("FEMALE") // "MALE" | "FEMALE" | "NEUTRAL"
  voiceSpeed   Float   @default(1.0)

  // Preferencias de Notificaciones
  pushEnabled            Boolean @default(true)
  emailEnabled           Boolean @default(false)
  smsEnabled             Boolean @default(false)
  proactiveAlertsEnabled Boolean @default(true)
  lateWarningsEnabled    Boolean @default(true)

  // Preferencias de Alarmas
  defaultAlarmTone     String?
  snoozeMinutes        Int     @default(5)
  gradualVolumeEnabled Boolean @default(true)

  // Idioma y Localización
  language   String @default("es")
  timezone   String @default("America/Argentina/Buenos_Aires")
  dateFormat String @default("DD/MM/YYYY")
  timeFormat String @default("24h")

  // Preferencias de Comunicación
  requireConfirmationBeforeSending Boolean @default(true)
  autoReplyEnabled                 Boolean @default(false)
  readReceiptsEnabled              Boolean @default(true)

  // Preferencias de Ubicación
  locationTrackingEnabled  Boolean @default(true)
  geofencingEnabled        Boolean @default(true)
  proximityThresholdMeters Int     @default(500)

  // Preferencias de MCPs
  allowDynamicMCPs      Boolean @default(true)
  mcpWhitelistedDomains String  @default("") // JSON string array

  // Intereses y Gustos (para personalización)
  interests          String @default("[]") // JSON array: ["deportes", "música", "tecnología", ...]
  favoriteCategories String @default("[]") // JSON array de categorías de eventos favoritas
  customPreferences  String @default("{}") // JSON object para preferencias adicionales

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}

// ========================================
//  PUSH NOTIFICATIONS
// ========================================

model PushToken {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Expo Push Token
  token String @unique

  // Device Info
  deviceId   String?
  deviceName String?
  deviceType String? // "android" | "ios"
  appVersion String?
  osVersion  String?
  platform   String? // "mobile" | "web"

  // Status
  active    Boolean   @default(true)
  lastUsed  DateTime  @default(now())
  expiresAt DateTime?

  // Notification Preferences (puede sobrescribir preferencias globales)
  notificationSettings String? // JSON: { "events": true, "reminders": true, "alarms": true }

  // Error tracking
  failureCount Int       @default(0)
  lastError    String?
  lastErrorAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, active])
  @@index([token])
  @@index([userId, lastUsed])
  @@map("push_tokens")
}

// ========================================
//  EVENTOS Y RECORDATORIOS
// ========================================

model Event {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String
  description String?
  type        String  @default("OTHER") // MEDICAL, MEETING, PERSONAL, WORK, BIRTHDAY, etc.

  // Fecha y hora
  startTime DateTime
  endTime   DateTime?
  allDay    Boolean   @default(false)
  timezone  String?

  // Ubicación
  location String?
  placeId  String?
  place    Place?  @relation(fields: [placeId], references: [id])

  // Participantes
  participants String @default("") // JSON string array

  // Recordatorios asociados
  reminders Reminder[]

  // Metadata
  createdVia String  @default("VOICE") // VOICE, MANUAL, IMPORT, MCP
  completed  Boolean @default(false)
  canceled   Boolean @default(false)

  // Sincronización con calendarios externos
  externalId     String?
  externalSource String?

  // Ubicación relacionada
  locationLogs LocationLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, startTime])
  @@index([userId, type])
  @@index([userId, completed])
  @@index([userId, canceled])
  @@map("events")
}

model Reminder {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId String?
  event   Event?  @relation(fields: [eventId], references: [id], onDelete: Cascade)

  title   String
  message String?

  // Cuándo recordar
  remindAt DateTime

  // Canal de recordatorio
  channel String @default("PUSH") // PUSH, EMAIL, SMS, VOICE

  // Estado
  sent        Boolean   @default(false)
  read        Boolean   @default(false)
  snoozed     Boolean   @default(false)
  snoozeUntil DateTime?

  // Repetición
  recurring      Boolean @default(false)
  recurrenceRule String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, remindAt])
  @@index([userId, sent])
  @@map("reminders")
}

// ========================================
//  ALARMAS / DESPERTADOR
// ========================================

model Alarm {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name  String?
  label String?

  // Hora de la alarma
  time String // "07:00" (formato 24h)

  // Días de la semana activos (JSON)
  daysActive String // {"mon":true,"tue":true,...}

  // Configuración de sonido
  soundType String  @default("DEFAULT") // DEFAULT, MUSIC, VOICE, GENTLE, NATURE
  musicId   String?
  musicName String?
  musicUrl  String?

  // Mensaje personalizado de despertar
  wakeMessage String?
  readAgenda  Boolean @default(true)

  // Comportamiento
  vibration  Boolean @default(true)
  snooze     Boolean @default(true)
  snoozeTime Int     @default(5)
  maxSnoozes Int     @default(3)

  // Volumen gradual
  gradualVolume  Boolean @default(true)
  volumeStart    Int     @default(30)
  volumeEnd      Int     @default(70)
  volumeDuration Int     @default(60)

  // Estado
  enabled Boolean @default(true)

  // Última ejecución
  lastTriggered DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, enabled])
  @@map("alarms")
}

// ========================================
//  MCPs (Model Context Protocols)
// ========================================

model MCP {
  id          String @id @default(cuid())
  name        String
  type        String // PRECONFIGURED, DYNAMIC, USER_CREATED
  category    String // COMMUNICATION, LOCATION, WEB, MEDIA, PRODUCTIVITY, etc.
  description String
  version     String @default("1.0.0")

  // Capabilities (JSON)
  capabilities String // JSON array

  // Schemas (JSON)
  inputSchema  String // JSON
  outputSchema String // JSON

  // Executor code
  executorCode String // JavaScript/TypeScript code
  executorType String @default("inline")

  // Configuration (JSON)
  config String? // JSON

  // Métricas
  usageCount         Int  @default(0)
  successCount       Int  @default(0)
  failureCount       Int  @default(0)
  avgExecutionTimeMs Int?

  // Rating
  rating Float?

  // Para MCPs dinámicos
  generatedBy String?
  prompt      String?

  // Relaciones
  executions MCPExecution[]

  // Estado
  enabled Boolean @default(true)
  public  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([enabled, public])
  @@index([type, category])
  @@map("mcps")
}

model MCPExecution {
  id    String @id @default(cuid())
  mcpId String
  mcp   MCP    @relation(fields: [mcpId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Input/Output (JSON)
  inputData  String // JSON
  outputData String? // JSON

  // Resultado
  success         Boolean
  errorMessage    String?
  executionTimeMs Int?

  // Feedback del usuario
  userFeedback    String? // POSITIVE, NEGATIVE, NEUTRAL
  feedbackComment String?

  // Contexto
  triggeredBy String?

  createdAt DateTime @default(now())

  @@map("mcp_executions")
}

// ========================================
//  COMUNICACIÓN
// ========================================

model Message {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  platform  String // WHATSAPP, EMAIL, SMS
  direction String // INCOMING, OUTGOING

  content String

  // Para emails
  subject String?

  // Para media
  mediaUrl  String?
  mediaType String?

  // Status
  status String    @default("SENT") // SENT, DELIVERED, READ, FAILED
  read   Boolean   @default(false)
  readAt DateTime?

  // Metadata
  externalId   String?
  errorMessage String?

  // Threading
  threadId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, contactId])
  @@index([userId, platform])
  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([threadId])
  @@map("messages")
}

model Contact {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  deviceId String?
  name     String
  nickname String?

  // Teléfonos y emails (JSON arrays)
  phoneNumbers String @default("[]") // JSON array
  emails       String @default("[]") // JSON array

  // Avatar
  avatarUrl String?

  // Metadata (JSON)
  tags  String  @default("[]") // JSON array
  notes String?

  // Estadísticas
  messageCount  Int       @default(0)
  lastContactAt DateTime?

  // Integración
  hasWhatsApp Boolean @default(false)

  // Relaciones
  messages Message[]

  // Sincronización
  syncedAt DateTime?
  source   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, lastContactAt])
  @@map("contacts")
}

// ========================================
//  UBICACIÓN
// ========================================

model LocationLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  latitude  Float
  longitude Float
  accuracy  Float?
  altitude  Float?
  speed     Float?

  // Contexto
  eventId String?
  event   Event?  @relation(fields: [eventId], references: [id], onDelete: SetNull)

  action String? // ARRIVAL, DEPARTURE, PROXIMITY, CHECK

  // Address
  address String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([eventId])
  @@map("location_logs")
}

model Place {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  name      String
  address   String
  latitude  Float
  longitude Float

  // Google Places
  placeId   String? @unique
  placeType String?

  // Cache de información (JSON)
  openingHours String? // JSON
  phone        String?
  website      String?
  rating       Float?
  priceLevel   Int?

  // Asociación con eventos
  events Event[]

  // Frecuencia
  visitCount  Int       @default(0)
  lastVisitAt DateTime?

  // Sincronización
  lastFetchedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, visitCount])
  @@index([placeId])
  @@map("places")
}

// ========================================
//  VOZ Y SESIONES
// ========================================

model VoiceSession {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  transcript String
  intent     String?
  entities   String? // JSON

  response String?

  confidence Float?
  successful Boolean @default(false)

  duration Int?

  // Contexto
  previousSessionId String?
  contextData       String? // JSON

  // Audio
  audioUrl String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, successful])
  @@map("voice_sessions")
}

// ========================================
//  ANALYTICS
// ========================================

model AppUsageLog {
  id     String @id @default(cuid())
  userId String

  action   String
  screen   String?
  metadata String? // JSON

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([userId, action])
  @@map("app_usage_logs")
}

// ============================================================================
// SISTEMA DE CONTEXTO
// ============================================================================

model Context {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  entityId   String @unique
  entityType String // 'TASK' | 'EVENT' | 'APPOINTMENT'

  // Las 5 dimensiones (JSON por ahora)
  temporal    String
  spatial     String
  priority    String
  relational  String
  intentional String

  contextScore Float    @default(50)
  version      Int      @default(1)
  lastUpdated  DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, contextScore])
  @@index([userId, entityType])
  @@index([entityId])
  @@map("contexts")
}

// ============================================================================
// CLUSTERING INTELIGENTE
// ============================================================================

model Cluster {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  description String?
  type        String // 'PROJECT' | 'ROUTINE' | 'GOAL' | 'CONTEXT_BASED'

  color String?
  icon  String?

  centroid String?
  cohesion Float   @default(0)
  size     Int     @default(0)

  autoGenerated Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, type])
  @@index([userId, autoGenerated])
  @@map("clusters")
}

// ============================================================================
// ACCIONES SUGERIDAS POR IA
// ============================================================================

model Action {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  triggerId   String
  triggerType String

  actionType       String
  targetEntityId   String
  targetEntityType String

  title       String
  description String
  reasoning   String // Array de strings en JSON
  confidence  Float

  isAutomatic          Boolean @default(false)
  requiresConfirmation Boolean @default(true)
  payload              String // JSON

  state String @default("PENDING")

  userFeedback String?

  createdAt  DateTime  @default(now())
  executedAt DateTime?
  expiresAt  DateTime?

  @@index([userId, state, createdAt])
  @@index([userId, targetEntityId])
  @@index([state, expiresAt])
  @@map("actions")
}

// ============================================================================
// CONTEXT STACK (Historial de Interacciones)
// ============================================================================

model InteractionLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  action     String
  entityId   String?
  entityType String?
  duration   Int // Milisegundos

  contextSnapshot String? // JSON
  metadata        String? // JSON

  timestamp DateTime @default(now())

  @@index([userId, timestamp])
  @@index([userId, action])
  @@index([entityId])
  @@map("interaction_logs")
}

// ============================================================================
// PATRONES DETECTADOS
// ============================================================================

model Pattern {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  sequence   String // Secuencia de acciones en JSON
  frequency  Int    @default(1)
  confidence Float  @default(0)

  typicalContext String? // JSON
  lastOccurred   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, frequency])
  @@index([userId, lastOccurred])
  @@map("patterns")
}

// ============================================================================
// FEEDBACK DEL USUARIO
// ============================================================================

model UserFeedback {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  predictionId   String?
  predictionType String

  wasCorrect    Boolean
  actualAction  String?
  actualOutcome String? // JSON

  comment String?

  timestamp DateTime @default(now())

  @@index([userId, predictionType])
  @@index([predictionId])
  @@map("user_feedbacks")
}
